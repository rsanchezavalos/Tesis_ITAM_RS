<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Tesis_map</title>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="//code.jquery.com/jquery-2.0.0.js"></script>

    <style>

        #map {
          background-color: #fff;
          border: 1px solid #ccc;
          margin: auto;
        }

        .background {
          fill: none;
          pointer-events: all;
        }

        #municipalities .active, #states .active {
          fill: #89a;
        }
        #cities {
          stroke-width: 0;
        }
        .city {
          fill: #345;
          stroke: #fff;
        }
        pre.prettyprint {
          border: 1px solid #ccc;
          margin-bottom: 0;
          padding: 9.5px;
        }

        .municipalities :hover {
          fill: orange;
        }


        .state-boundary {
          fill: none;
          stroke: #fff;
          pointer-events: none;
        }

        .municipality-boundary {
          fill: none;
          stroke: #fff;
          stroke-opacity: .25;
|          stroke-width: .1px;
          pointer-events: none;
        }

        div.tooltip {   
          position: absolute;           
          text-align: center;           
          width: 400px;                  
          height: 28px;                 
          padding: 2px;             
          font: 12px sans-serif;        
          background: "#bdbdbd";   
          border: 0px;      
          border-radius: 1px;           
          pointer-events: none;         
        }

        .boxed {
            color: black;
            margin-left: auto;
            margin-right: auto;
            text-align: center;  
            border-radius: 25px;
            border: 2px solid black;
            padding: 20px;
            height: 80px;
            width: 30%;                  
        }
     .form-control{
          display: inline-block;
          width: 30%;                  
        }

    </style>
  </head>
  <body>

    <select class="form-control" onchange="myFunction(this.value)">
      <option value="Basic">Basic</option>
      <option value="Color A">Color A</option>
      <option value="Color B">Color B</option>
      <option>3</option>
      <option>4</option>
      <option>5</option>
    </select>
    <select class="form-control" onchange="myFunction(this.value)">
      <option value="Basic">Basic</option>
      <option value="Color A">Color A</option>
      <option value="Color B">Color B</option>
      <option>3</option>
      <option>4</option>
      <option>5</option>
    </select>

    <div id="map"></div>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script>

    $("body").css("overflow", "auto");
    //variable definition
    var m_width = $("#map").width() * .6,
        width = 960,
        height = 628,
        country,
        state;

    //geographic projection definition
    var projection = d3.geo.conicConformal()
        .rotate([102, 0])
        .center([0, 24])
        .parallels([17.5, 29.5])
        .scale(1850)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    //******************************
    //Div information design, could be a simple box
    var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

    var text_div = d3.select("body").append("div").attr("class","boxed")
        .style("opacity", 50);
 
    //******************************
    // Map loader
    d3.json("mx.json", function(error, mx) {
      if (error) throw error;
        g.append("g")
        .attr("id", "municipalities")
        .attr("class", "municipalities")
        .selectAll("path")
        .data(topojson.feature(mx, mx.objects.municipalities).features)
        .enter()
        .append("path")     
        //attribute for color function
        .attr("class", "color-boundary")
        .attr("fill","grey")
        .attr("d", path)
        .on("mouseover", function(d){
          div.transition()        
            .duration(200)      
            .style("opacity", .9);      
          console.log(d.properties);
          div.html("Municipio: " + d.properties.name + "<br/>Estado: " + d.properties.state + "<br/>" )  
            .style("left", (d3.event.pageX) + "px")     
            .style("top", (d3.event.pageY - 28) + "px");;
          text_div      
            .style("opacity", 50);      
          text_div.html("Municipio: " + d.properties.name + "<br/>Estado: " + d.properties.state + "<br/>" )  
            .style("left", (d3.event.pageX) + "px")     
            .style("top", (d3.event.pageY - 28) + "px")
          })

        .on("click", country_clicked);
          });

    var svg = d3.select("#map").append("svg")
        .attr("preserveAspectRatio", "xMidYMid")
        .attr("viewBox", "0 0 " + width + " " + height)
        .attr("width", m_width)
        .attr("height", m_width * height / width);
    svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height)
        .on("click", country_clicked);


    var g = svg.append("g");


    function zoom(xyz) {
      g.transition()
        .duration(750)
        .attr("transform", "translate(" + projection.translate() + ")scale(" + xyz[2] + ")translate(-" + xyz[0] + ",-" + xyz[1] + ")")
        .selectAll(["#municipalities", "#states", "#cities"])
        .style("stroke-width", 1.0 / xyz[2] + "px")
        .selectAll(".city")
        .attr("d", path.pointRadius(20.0 / xyz[2]));
    }

    function get_xyz(d) {
      var bounds = path.bounds(d);
      var w_scale = (bounds[1][0] - bounds[0][0]) / width;
      var h_scale = (bounds[1][1] - bounds[0][1]) / height;
      var z = .96 / Math.max(w_scale, h_scale);
      var x = (bounds[1][0] + bounds[0][0]) / 2;
      var y = (bounds[1][1] + bounds[0][1]) / 2 + (height / z / 6);
      return [x, y, z];
    }

    //state_clicked - podemos agregar funcionalidad para que aparezca un cuadro.
    function country_clicked(d) {
      g.selectAll(["#states", "#cities"]).remove();
      state = null;
      if (country) {
        g.selectAll("#" + country.id).style('display', null);
      }
      if (d && country !== d) {
        var xyz = get_xyz(d);
        country = d;
        if (d.id  == 'USA' || d.id == 'JPN') {
          d3.json("/json/states_" + d.id.toLowerCase() + ".topo.json", function(error, us) {
            g.append("g")
              .attr("id", "states")
              .selectAll("path")
              .data(topojson.feature(us, us.objects.states).features)
              .enter()
              .append("path")
              .attr("id", function(d) { return d.id; })
              .attr("class", "active")
              .attr("d", path)
              .on("click", state_clicked);
            zoom(xyz);
            g.selectAll("#" + d.id).style('display', 'none');
          });      
        } else {
          zoom(xyz);
        }
      } else {
        var xyz = [width / 2, height / 2, 1];
        country = null;
        zoom(xyz);
      }
    }

    function state_clicked(d) {
      g.selectAll("#cities").remove();
      if (d && state !== d) {
        var xyz = get_xyz(d);
        state = d;
        country_code = state.id.substring(0, 3).toLowerCase();
        state_name = state.properties.name;
        d3.json("/json/cities_" + country_code + ".topo.json", function(error, us) {
          g.append("g")
            .attr("id", "cities")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.cities).features.filter(function(d) { return state_name == d.properties.state; }))
            .enter()
            .append("path")
            .attr("id", function(d) { return d.properties.name; })
            .attr("class", "city")
            .attr("d", path.pointRadius(20 / xyz[2]));
          zoom(xyz);
        });      
      } else {
        state = null;
        country_clicked(country);
      }
    }
    $(window).resize(function() {
      var w = $("#map").width();
      svg.attr("width", w);
      svg.attr("height", w * height / width);
    });

       svg.selectAll(".municipalities").append("path")
            .datum(topojson.mesh(mx, mx.objects.municipalities, function(a, b) { return a.properties.state !== b.properties.state; }))
            .attr("class", "state-boundary")
            .attr("d", path)
            .on("mouseover", function(d){
              console.log(d);
            });


      //******************************
      //Color Functions Wrapper
      d3.select(self.frameElement).style("height", height + "px");
      d3.select()
        function mycolorfunction(value){
          if (value.properties.name.length % 2 == 1) {
            return "#af8dc3";
          } else{
            return "#9e0142";
          }
        }
      var mis_colores = function(d){
        if (d.properties.state % 2 == 1) {
          return "#fc8d59"
        } else{
          return "#99d594"
        }
      }
      function myFunction(d){
        var fn;
        if(d === "Color A"){
          fn = mis_colores;
        }
        else if(d === "Color B"){
          fn = mycolorfunction;
        }
        d3.selectAll(".color-boundary")
          .attr("fill",fn)
      }
      //******************************

    </script>
  </body>

</html>

